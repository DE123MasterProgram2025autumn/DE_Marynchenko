---
title: "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞ ‚Ññ4: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –∫–æ–¥—É –≤ R ‚Äî –≤—ñ–¥ —Ü–∏–∫–ª—ñ–≤ –¥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è"
subtitle: "–Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –¥–∞–Ω–∏—Ö | –ö—Ä–ù–£ —ñ–º. –ú. –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ"
author: "[–°–∏–¥–æ—Ä–µ–Ω–∫–æ –í–∞–ª–µ—Ä—ñ–π](https://www.linkedin.com/in/valeriy-sydorenko-6782279a/)"
date: last-modified
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    sidebar: left
    collapse-level: 2
    code-fold: true
    code-overflow: wrap
    page-layout: full
    include-in-footer:
    text: |
      <hr>
      <footer style="text-align: center; font-size: 0.9em; color: #666;">
        <p>–í–∏–∫–æ–Ω–∞–≤(–ª–∞): <strong>–ú–∞—Ä–∏–Ω—á–µ–Ω–∫–æ –í–∞–ª–µ—Ä—ñ—è –í—ñ—Ç–∞–ª—ñ—ó–≤–Ω–∞</strong> | –ì—Ä—É–ø–∞: <strong>–ö–Ü-24-1–º</strong> | –í–∏–∫–ª–∞–¥–∞—á: –°–∏–¥–æ—Ä–µ–Ω–∫–æ –í.–ú.</p>
        <p>–ö—Ä–µ–º–µ–Ω—á—É—Ü—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –ú–∏—Ö–∞–π–ª–∞ –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ &copy; 2025</p>
      </footer>
editor: visual
execute:
  echo: true
  warning: false
  message: false
---

## –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏

–û—Å–≤–æ—ó—Ç–∏ —Å—É—á–∞—Å–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏ –¥–æ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –∫–æ–¥—É –≤ R, –∑–æ–∫—Ä–µ–º–∞:\
- –∑–∞–º—ñ–Ω—É —ñ–º–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Ü–∏–∫–ª—ñ–≤ (`for`, `while`, `repeat`) –Ω–∞ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏** (`lapply`, `sapply`, `vapply`, `mapply`);\
- –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **–≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π** (`rowSums`, `colMeans`, `apply`);\
- –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫ (`try`, `tryCatch`) –¥–ª—è —Å—Ç—ñ–π–∫–æ—Å—Ç—ñ –∫–æ–Ω–≤–µ—î—Ä—ñ–≤.\
–ù–∞–≤—á–∏—Ç–∏—Å—è –ø–∏—Å–∞—Ç–∏ **–µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π, —á–∏—Ç–∞–±–µ–ª—å–Ω–∏–π —ñ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π –∫–æ–¥** —É —Ä–∞–º–∫–∞—Ö —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—ó –ø–∞—Ä–∞–¥–∏–≥–º–∏ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è.

## –©–æ –≤–∏ –±—É–¥–µ—Ç–µ –≤–º—ñ—Ç–∏ –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–æ–±–æ—Ç–∏?

-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—Ü–∏–∫–ª—ñ—á–Ω—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó** (`for`, `while`, `repeat`) –¥–ª—è –±–∞–∑–æ–≤–∏—Ö —ñ—Ç–µ—Ä–∞—Ü—ñ–π, –∞–ª–µ —Ä–æ–∑—É–º—ñ—Ç–∏ —ó—Ö–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è.\
-   –ó–∞–º—ñ–Ω—é–≤–∞—Ç–∏ —Ü–∏–∫–ª–∏ –Ω–∞ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏ —Å—ñ–º–µ–π—Å—Ç–≤–∞ `apply`** –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ —Ç–∞ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ.\
-   –ó–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ **–≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó** (`rowSums`, `colMeans`) –¥–ª—è —à–≤–∏–¥–∫–æ—ó –æ–±—Ä–æ–±–∫–∏ —Ç–∞–±–ª–∏—Ü—å.\
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **`lapply`/`sapply`/`vapply`** –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Å–ø–∏—Å–∫—ñ–≤, —Ñ–∞–π–ª—ñ–≤, –∫–æ–ª–µ–∫—Ü—ñ–π –¥–∞—Ç–∞—Ñ—Ä–µ–π–º—ñ–≤.\
-   –ó–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ **`mapply`** –¥–ª—è –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –∫—ñ–ª—å–∫–æ—Ö –≤–µ–∫—Ç–æ—Ä—ñ–≤.\
-   –Ü–Ω—Ç–µ–≥—Ä—É–≤–∞—Ç–∏ **–æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫** (`tryCatch`) —É –∫–æ–Ω–≤–µ—î—Ä–∏ –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —ó—Ö–Ω—å–æ—ó –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –Ω–µ–æ–¥–Ω–æ—Ä—ñ–¥–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏.\
-   –î–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏—Å—è **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—é –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è**, —É–Ω–∏–∫–∞—Ç–∏ –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ —ñ –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö.

------------------------------------------------------------------------

## –í—Å—Ç—É–ø

–£ R —ñ—Å–Ω—É—î –¥–≤–∞ —Å–≤—ñ—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è: **—ñ–º–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏–π** (—Ü–∏–∫–ª—ñ—á–Ω–∏–π, –ø–æ–∫—Ä–æ–∫–æ–≤–∏–π) —ñ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π** (–¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∏–π, –∑–∞—Å–Ω–æ–≤–∞–Ω–∏–π –Ω–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è—Ö). –•–æ—á–∞ —Ü–∏–∫–ª–∏ `for` —ñ `while` –∑–Ω–∞–π–æ–º—ñ –±—ñ–ª—å—à–æ—Å—Ç—ñ –ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç—ñ–≤, –≤–æ–Ω–∏ —á–∞—Å—Ç–æ –ø—Ä–∏–∑–≤–æ–¥—è—Ç—å –¥–æ **–ø–æ–≤—ñ–ª—å–Ω–æ–≥–æ, –≥—Ä–æ–º—ñ–∑–¥–∫–æ–≥–æ —Ç–∞ –≤–∞–∂–∫–æ–≥–æ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ–¥—É**, –æ—Å–æ–±–ª–∏–≤–æ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –≤–µ–ª–∏–∫–∏–º–∏ –æ–±—Å—è–≥–∞–º–∏ –¥–∞–Ω–∏—Ö.

–°—É—á–∞—Å–Ω–∞ —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—è –¥–∞–Ω–∏—Ö —É R “ë—Ä—É–Ω—Ç—É—î—Ç—å—Å—è –Ω–∞ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ–π –ø–∞—Ä–∞–¥–∏–≥–º—ñ**, –¥–µ: - –¥–∞–Ω—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **—á–∏—Å—Ç–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π** –±–µ–∑ –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤; - —ñ—Ç–µ—Ä–∞—Ü—ñ—ó —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏** (`*apply`, `purrr::map`); - –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–∞ –≤ –∫–æ–Ω–≤–µ—î—Ä –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `tryCatch`.

–¶—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑–Ω–∞–π–æ–º–∏—Ç—å –≤–∞—Å —ñ–∑:

1.  **–ë–∞–∑–æ–≤–∏–º–∏ —Ü–∏–∫–ª–∞–º–∏** ‚Äî —è–∫ –≤–æ–Ω–∏ –ø—Ä–∞—Ü—é—é—Ç—å —ñ —á–æ–º—É —ó—Ö –≤–∞—Ä—Ç–æ —É–Ω–∏–∫–∞—Ç–∏ –≤ production-–∫–æ–¥—ñ.

2.  **–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∞–º–∏** ‚Äî —è–∫ `lapply` —ñ `vapply` —Ä–æ–±–ª—è—Ç—å –∫–æ–¥ —à–≤–∏–¥—à–∏–º —ñ –±–µ–∑–ø–µ—á–Ω—ñ—à–∏–º.

3.  **–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü—ñ—î—é** ‚Äî —è–∫ –≤–±—É–¥–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (`rowSums`, `colMeans`) –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ C-—Ä—ñ–≤–Ω—ñ.

–í–∏ —Ç–∞–∫–æ–∂ –Ω–∞–≤—á–∏—Ç–µ—Å—è **–∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ–∫—ñ–ª—å–∫–æ—Ö —Ñ–∞–π–ª—ñ–≤**, **–∞–≥—Ä–µ–≥—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏** —Ç–∞ **–±–µ–∑–ø–µ—á–Ω–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ –≤–∏–Ω—è—Ç–∫–∏** ‚Äî –≤—Å–µ —Ü–µ —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º–∏ –Ω–∞–≤–∏—á–∫–∞–º–∏ –¥–ª—è —ñ–Ω–∂–µ–Ω–µ—Ä–∞ –¥–∞–Ω–∏—Ö.

## –¶–∏–∫–ª–∏ –≤ –±–∞–∑–æ–≤–æ–º—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—ñ R: `for`, `while` —Ç–∞ `repeat`

–£ –º–æ–≤—ñ R —ñ—Å–Ω—É—é—Ç—å —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —Ü–∏–∫–ª—ñ–≤, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –±–∞–≥–∞—Ç–æ—Ä–∞–∑–æ–≤–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –±–ª–æ–∫ –∫–æ–¥—É:

-   **`for`** ‚Äî –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ —É –∑–∞–¥–∞–Ω—ñ–π –∫–æ–ª–µ–∫—Ü—ñ—ó (–≤–µ–∫—Ç–æ—Ä—ñ, —Å–ø–∏—Å–∫—É, —Å—Ç–æ–≤–ø—Ü—ñ —Ç–∞–±–ª–∏—Ü—ñ). –Ü–¥–µ–∞–ª—å–Ω–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –≤—ñ–¥–æ–º–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —ñ—Ç–µ—Ä–∞—Ü—ñ–π.
-   **`while`** ‚Äî –ø–æ–≤—Ç–æ—Ä—é—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –¥–æ–∫–∏ –∑–∞–¥–∞–Ω–∞ —É–º–æ–≤–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —ñ—Å—Ç–∏–Ω–Ω–æ—é (`TRUE`). –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, –∫–æ–ª–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π –∑–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å –Ω–µ–≤—ñ–¥–æ–º–∞.
-   **`repeat`** ‚Äî —Å—Ç–≤–æ—Ä—é—î –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–π —Ü–∏–∫–ª, —è–∫–∏–π –ø–µ—Ä–µ—Ä–∏–≤–∞—î—Ç—å—Å—è –ª–∏—à–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ `break`. –ö–æ—Ä–∏—Å–Ω–∏–π —É —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö, –¥–µ —É–º–æ–≤–∞ –≤–∏—Ö–æ–¥—É –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç—ñ–ª–∞ —Ü–∏–∫–ª—É.

–•–æ—á–∞ —Ü—ñ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∑–Ω–∞–π–æ–º—ñ –ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç–∞–º –∑ —ñ–Ω—à–∏—Ö –º–æ–≤, —É R –≤–æ–Ω–∏ —á–∞—Å—Ç–æ –ø—Ä–∏–∑–≤–æ–¥—è—Ç—å –¥–æ **–Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ, –ø–æ–≤—ñ–ª—å–Ω–æ–≥–æ –∫–æ–¥—É**, –æ—Å–æ–±–ª–∏–≤–æ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –≤–µ–ª–∏–∫–∏–º–∏ –æ–±—Å—è–≥–∞–º–∏ –¥–∞–Ω–∏—Ö. –¶–µ –ø–æ–≤‚Äô—è–∑–∞–Ω–æ –∑ —Ç–∏–º, —â–æ R ‚Äî –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞ –º–æ–≤–∞, —ñ –±–∞–≥–∞—Ç–æ –æ–ø–µ—Ä–∞—Ü—ñ–π –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ **–±–µ–∑ —è–≤–Ω–∏—Ö —Ü–∏–∫–ª—ñ–≤**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏ (`lapply`, `map`) –∞–±–æ –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (`rowSums`, `ifelse` —Ç–æ—â–æ).

–¢–æ–º—É —Ü–∏–∫–ª–∏ –≤ R –≤–∞—Ä—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **–ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ –Ω–µ–º–∞—î –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏**, –∞ –≤ —ñ–Ω—à–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö ‚Äî –≤—ñ–¥–¥–∞–≤–∞—Ç–∏ –ø–µ—Ä–µ–≤–∞–≥—É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–º—É –ø—ñ–¥—Ö–æ–¥—É, —è–∫–∏–π –∑–∞–±–µ–∑–ø–µ—á—É—î –∫—Ä–∞—â—É –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å, —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å —ñ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å –∫–æ–¥—É.

### –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è 1

–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ [—á–∞—Å—Ç–∏–Ω—É 1.](lab4_DE_2022_part1.R)

## –§—É–Ω–∫—Ü—ñ—ó —Å—ñ–º–µ–π—Å—Ç–≤–∞ `apply`: —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Ü–∏–∫–ª–∞–º

–£ –º–æ–≤—ñ R –∑–∞–º—ñ—Å—Ç—å —ñ–º–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Ü–∏–∫–ª—ñ–≤ (`for`, `while`) —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏** ‚Äî —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫—ñ –ø—Ä–∏–π–º–∞—é—Ç—å —ñ–Ω—à—É —Ñ—É–Ω–∫—Ü—ñ—é —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç —ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å —ó—ó –¥–æ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –¥–∞–Ω–∏—Ö. –¶–µ –Ω–µ –ª–∏—à–µ —Ä–æ–±–∏—Ç—å –∫–æ–¥ **–∫–æ—Ä–æ—Ç—à–∏–º —ñ —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—à–∏–º**, –∞ –π –∑–Ω–∞—á–Ω–æ **–ø—ñ–¥–≤–∏—â—É—î –π–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å**, –æ—Å–∫—ñ–ª—å–∫–∏ –±–∞–≥–∞—Ç–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—ñ–≤ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –Ω–∞ —Ä—ñ–≤–Ω—ñ C.

–û—Å–Ω–æ–≤–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Å—ñ–º–µ–π—Å—Ç–≤–∞ `apply`:

-   **`lapply()`** ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —Ñ—É–Ω–∫—Ü—ñ—é –¥–æ –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫—É –∞–±–æ –≤–µ–∫—Ç–æ—Ä–∞ —ñ **–∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫**. –Ü–¥–µ–∞–ª—å–Ω–∞ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–æ–ª–µ–∫—Ü—ñ–π –¥–∞—Ç–∞—Ñ—Ä–µ–π–º—ñ–≤, —Ñ–∞–π–ª—ñ–≤, –º–æ–¥–µ–ª–µ–π —Ç–æ—â–æ.
-   **`sapply()`** ‚Äî —Å–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è `lapply()`, —è–∫–∞ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è **—Å–ø—Ä–æ—Å—Ç–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –¥–æ –≤–µ–∫—Ç–æ—Ä–∞ –∞–±–æ –º–∞—Ç—Ä–∏—Ü—ñ (—è–∫—â–æ —Ü–µ –º–æ–∂–ª–∏–≤–æ).
-   **`vapply()`** ‚Äî –±–µ–∑–ø–µ—á–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ `sapply()`, –¥–µ –≤–∏ **–≤–∫–∞–∑—É—î—Ç–µ –æ—á—ñ–∫—É–≤–∞–Ω–∏–π —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É** (`FUN.VALUE`). –¶–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–∏–º –ø–æ–º–∏–ª–∫–∞–º —ñ –ø—Ä–∏—Å–∫–æ—Ä—é—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è.
-   **`mapply()`** ‚Äî —É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–Ω—è `sapply()` –¥–ª—è **–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –∫—ñ–ª—å–∫–æ—Ö –≤–µ–∫—Ç–æ—Ä—ñ–≤** (–∞–Ω–∞–ª–æ–≥ `map2()` –∞–±–æ `pmap()` –∑ `purrr`).
-   **`apply()`** ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —Ñ—É–Ω–∫—Ü—ñ—é –¥–æ **—Ä—è–¥–∫—ñ–≤ (1) –∞–±–æ —Å—Ç–æ–≤–ø—Ü—ñ–≤ (2)** –º–∞—Ç—Ä–∏—Ü—ñ —á–∏ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞. –ö–æ—Ä–∏—Å–Ω–∞ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü—ñ—ó, –∞–ª–µ —á–∞—Å—Ç–æ –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–º—ñ–Ω–µ–Ω–∞ –Ω–∞ –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (`rowSums()`, `colMeans()`), —è–∫—ñ —â–µ —à–≤–∏–¥—à—ñ.

–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏ –æ—Å–æ–±–ª–∏–≤–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ –≤ –ø–æ—î–¥–Ω–∞–Ω–Ω—ñ –∑ **–∫–æ–Ω–≤–µ—î—Ä–∞–º–∏ (`%>%`)** —Ç–∞ **–∞–Ω–æ–Ω—ñ–º–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –±—É–¥—É–≤–∞—Ç–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ñ, –≤–∏—Ä–∞–∑–Ω—ñ —Ç–∞ –ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ ETL-–ø—Ä–æ—Ü–µ—Å–∏. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –æ–±‚Äô—î–¥–Ω–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Ö CSV-—Ñ–∞–π–ª—ñ–≤ –∑–≤–æ–¥–∏—Ç—å—Å—è –¥–æ –¥–≤–æ—Ö —Ä—è–¥–∫—ñ–≤:

``` r
file_paths <- list.files("data", pattern = "\\.csv$", full.names = TRUE)
all_data <- lapply(file_paths, read.csv) %>% bind_rows()
```

–¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –Ω–µ –ª–∏—à–µ –∑–∞–º—ñ–Ω—é—î —Ü–∏–∫–ª, –∞ –π —É—Å—É–≤–∞—î –ø–æ—Ç—Ä–µ–±—É –≤ –ø—Ä–æ–º—ñ–∂–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö —Ç–∞ —Ä—É—á–Ω–æ–º—É —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—ñ –ø–∞–º‚Äô—è—Ç—Ç—é.

–û—Ç–∂–µ, **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è ‚Äî —Ü–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç —Å—É—á–∞—Å–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö —É R**, —ñ –≤–æ–ª–æ–¥—ñ–Ω–Ω—è —Å—ñ–º–µ–π—Å—Ç–≤–æ–º `apply` —î –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ—é –∫–æ–º–ø–µ—Ç–µ–Ω—Ü—ñ—î—é –¥–ª—è –±—É–¥—å-—è–∫–æ–≥–æ Data Engineer.

### –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è 2

–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ [—á–∞–∞—Å—Ç–∏–Ω—É 2](lab4_DE_2022_part2.R)

## –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ —É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—ñ: `tryCatch()` –∑ `lapply()`

–£ —Ä–µ–∞–ª—å–Ω–∏—Ö ETL-–ø—Ä–æ—Ü–µ—Å–∞—Ö –¥–∞–Ω—ñ —á–∞—Å—Ç–æ –º—ñ—Å—Ç—è—Ç—å –∞–Ω–æ–º–∞–ª—ñ—ó: –ø–æ—à–∫–æ–¥–∂–µ–Ω—ñ —Ñ–∞–π–ª–∏, –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ URL, –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω—ñ —Ç–∏–ø–∏ –¥–∞–Ω–∏—Ö. –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–∏–∫–ª `for` –±–µ–∑ –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫, **–≤—Å—è –ø—Ä–æ–≥—Ä–∞–º–∞ –∑—É–ø–∏–Ω–∏—Ç—å—Å—è –Ω–∞ –ø–µ—Ä—à—ñ–π –ø–æ–º–∏–ª—Ü—ñ**. –¶–µ –Ω–µ–ø—Ä–∏–π–Ω—è—Ç–Ω–æ –≤ —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö, –¥–µ –≤–∞–∂–ª–∏–≤–∞ **—Å—Ç—ñ–π–∫—ñ—Å—Ç—å –∫–æ–Ω–≤–µ—î—Ä–∞**.

–ó–∞–º—ñ—Å—Ç—å —Ü—å–æ–≥–æ –º–∏ –≤–±—É–¥–æ–≤—É—î–º–æ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ **–±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `tryCatch()` —Ä–∞–∑–æ–º –∑ `lapply()` –∞–±–æ `map()`:

``` r
# –ë–µ–∑–ø–µ—á–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É
safe_read_csv <- function(path) {
  tryCatch(
    read.csv(path, sep = "\t"),
    error = function(e) {
      message("‚ùó –ü–æ–º–∏–ª–∫–∞ —É —Ñ–∞–π–ª—ñ ", path, ": ", e$message)
      # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π tibble —Ç—ñ—î—ó –∂ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ (–∞–±–æ –ø—Ä–æ—Å—Ç–æ NULL)
      tibble(.rows = 0)
    }
  )
}

# –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–µ—è–∫—ñ –ø–æ—à–∫–æ–¥–∂–µ–Ω—ñ
file_paths <- list.files("data", pattern = "\\.csv$", full.names = TRUE)
all_data <- lapply(file_paths, safe_read_csv) %>% bind_rows()
```

–¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –º–∞—î –∫—ñ–ª—å–∫–∞ –ø–µ—Ä–µ–≤–∞–≥:

-   **–ö–æ–Ω–≤–µ—î—Ä –Ω–µ –ø–µ—Ä–µ—Ä–∏–≤–∞—î—Ç—å—Å—è** ‚Äî –æ–±—Ä–æ–±–∫–∞ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è –¥–ª—è –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤.

-   **–ü–æ–º–∏–ª–∫–∏ –ª–æ–≥—É—é—Ç—å—Å—è** ‚Äî –≤–∏ –∑–Ω–∞—î—Ç–µ, —â–æ –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫.

-   **–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è tidy** ‚Äî –ø–æ—Ä–æ–∂–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ –Ω–µ –ø–æ—Ä—É—à—É—é—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

-   **–§—É–Ω–∫—Ü—ñ—è —á–∏—Å—Ç–∞** ‚Äî –Ω–µ –º–∞—î –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤, –ª–µ–≥–∫–æ —Ç–µ—Å—Ç—É—î—Ç—å—Å—è.

> üí° **–ü–æ—Ä–∞–¥–∞**: —É production-–∫–æ–¥—ñ –∑–∞–º—ñ—Å—Ç—å `message()` —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –ª–æ–≥—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –ø–∞–∫–µ—Ç `logger` –∞–±–æ –∑–∞–ø–∏—Å —É —Ñ–∞–π–ª, –∞–ª–µ –¥–ª—è –Ω–∞–≤—á–∞–ª—å–Ω–∏—Ö —Ü—ñ–ª–µ–π `message()` –¥–æ—Å—Ç–∞—Ç–Ω—å–æ.

–¢–∞–∫–∏–º —á–∏–Ω–æ–º, **`tryCatch()` —É –ø–æ—î–¥–Ω–∞–Ω–Ω—ñ –∑ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∞–º–∏** ‚Äî —Ü–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç —Å—É—á–∞—Å–Ω–æ—ó —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö —É R, —è–∫–∏–π –∑–∞–±–µ–∑–ø–µ—á—É—î –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å, —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å —ñ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å –∫–æ–¥—É.

## –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è

-   –í–∏–∫–æ–Ω–∞—Ç–∏ [–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è](#–≤–∞—Ä—ñ–∞–Ω—Ç–∏-—ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏—Ö-–∑–∞–≤–¥–∞–Ω—å)

## –í–∞—Ä—ñ–∞–Ω—Ç 1

### **–¢–µ–º–∞: –ê–Ω–∞–ª—ñ–∑ —è–∫–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö —É –ø–∞–ø—Ü—ñ –∑ —â–æ–º—ñ—Å—è—á–Ω–∏–º–∏ –∑–≤—ñ—Ç–∞–º–∏**

–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø–∞–ø–∫—É `monthly_reports/`, —è–∫–∞ –º—ñ—Å—Ç–∏—Ç—å **12 CSV-—Ñ–∞–π–ª—ñ–≤** (`jan.csv`, `feb.csv`, ..., `dec.csv`) –∑—ñ –∑–≤—ñ—Ç–∞–º–∏ –ø—Ä–æ –ø—Ä–æ–¥–∞–∂—ñ. –û–¥–Ω–∞–∫ –¥–µ—è–∫—ñ —Ñ–∞–π–ª–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏: - –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–º–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç, –≤—ñ–¥—Å—É—Ç–Ω—ñ —Å—Ç–æ–≤–ø—Ü—ñ), - –ø–æ—Ä–æ–∂–Ω—ñ–º–∏, - –º—ñ—Å—Ç–∏—Ç–∏ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ —Ü—ñ–Ω–∏, `NA` —É –∫–ª—é—á–æ–≤–∏—Ö –ø–æ–ª—è—Ö).

–í–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø–æ–±—É–¥—É–≤–∞—Ç–∏ **–Ω–∞–¥—ñ–π–Ω–∏–π, –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π ETL-–∫–æ–Ω–≤–µ—î—Ä** —É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—ñ.

------------------------------------------------------------------------

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö

–ö–æ–∂–µ–Ω —Ñ–∞–π–ª –º–∞—î —Å—Ç–æ–≤–ø—Ü—ñ:\
`product_id`, `region`, `units_sold`, `price_per_unit`, `discount_percent`

------------------------------------------------------------------------

```{r setup, include=FALSE}
#install.packages("knitr")
knitr::opts_chunk$set(echo = TRUE, message = TRUE)
```

```{r}
library(dplyr)
library(readr)
library(purrr)
library(tidyr)

# –û—á—ñ–∫—É–≤–∞–Ω—ñ –Ω–∞–∑–≤–∏ —Å—Ç–æ–≤–ø—Ü—ñ–≤
EXPECTED_COLS <- c("product_id", "region", "units_sold", "price_per_unit", "discount_percent")
```

### –ó–∞–≤–¥–∞–Ω–Ω—è

### **–ï—Ç–∞–ø 1: –ë–µ–∑–ø–µ—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤**

-   –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `safe_read_report(path)`, —è–∫–∞:
    -   –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `tryCatch()` –¥–ª—è –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ;
    -   —É —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏ ‚Äî –≤–∏–≤–æ–¥–∏—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `message()` —ñ –ø–æ–≤–µ—Ä—Ç–∞—î **–ø–æ—Ä–æ–∂–Ω—ñ–π tibble** –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —Å—Ç–æ–≤–ø—Ü—è–º–∏;
    -   –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —É—Å—ñ—Ö 5 —Å—Ç–æ–≤–ø—Ü—ñ–≤; —è–∫—â–æ —á–æ–≥–æ—Å—å –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—ñ–π tibble.
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `list.files()` + `lapply()` (–∞–±–æ `map()`) –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤.
-   –û–±‚Äô—î–¥–Ω–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É —î–¥–∏–Ω—É —Ç–∞–±–ª–∏—Ü—é `all_sales`.

```{r}
# –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ç–∏–ø–∏ —Å—Ç–æ–≤–ø—Ü—ñ–≤
EXPECTED_COL_TYPES <- cols(
  product_id = col_character(), 
  region = col_character(), 
  units_sold = col_double(), # –û–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∫–∞–∑—É—î–º–æ —á–∏—Å–ª–æ
  price_per_unit = col_double(), 
  discount_percent = col_double()
)

safe_read_report <- function(path) {
  # –ü–æ—Ä–æ–∂–Ω—ñ–π DF –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ/–Ω–µ–≤–¥–∞—á—ñ
  empty_df <- tibble(
    product_id = character(), region = character(), units_sold = double(), 
    price_per_unit = double(), discount_percent = double()
  )
  file_name <- basename(path)
  
  df <- tryCatch({
    # !!! –í–ò–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∏–º—É—Å–æ–≤–æ –≤–∫–∞–∑—É—î–º–æ —Ç–∏–ø–∏ —Å—Ç–æ–≤–ø—Ü—ñ–≤ !!!
    d <- readr::read_csv(path, col_types = EXPECTED_COL_TYPES, show_col_types = FALSE)
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –≤—Å—ñ—Ö —Å—Ç–æ–≤–ø—Ü—ñ–≤ (–ø—ñ—Å–ª—è —á–∏—Ç–∞–Ω–Ω—è)
    if (!all(names(EXPECTED_COL_TYPES$cols) %in% names(d))) {
      message(sprintf("%s –≤—ñ–¥—Å—É—Ç–Ω—ñ –∫–ª—é—á–æ–≤—ñ —Å—Ç–æ–≤–ø—Ü—ñ.", file_name))
      return(empty_df)
    }
    
    return(d)
    
  }, error = function(e) {
    # –ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è –∞–±–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
    message(sprintf("–ø–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É: %s. %s", file_name, e$message))
    return(empty_df)
  })
  
  return(df)
}
# –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é
all_sales_list_fixed <- file_info %>%
  mutate(data = map(path, safe_read_report))

# –û–±'—î–¥–Ω–∞–Ω–Ω—è, —è–∫–µ —Ç–µ–ø–µ—Ä –ø–æ–≤–∏–Ω–Ω–æ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –ø–æ–º–∏–ª–æ–∫ —Ç–∏–ø—ñ–≤
all_sales_fixed <- all_sales_list_fixed %>%
  mutate(month = gsub("\\.csv", "", file_name)) %>%
  unnest(data) %>%
  select(-path, -file_name) 

cat("\n–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –æ–±'—î–¥–Ω–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º —Ç–∏–ø—ñ–≤. –ü–µ—Ä—à—ñ —Ä—è–¥–∫–∏ all_sales_fixed:\n")
print(head(all_sales_fixed))

all_file_paths <- list.files("data/monthly_reports", full.names = TRUE, pattern = "\\.csv$")

file_info <- tibble(
  path = all_file_paths,
  file_name = basename(all_file_paths)
)

all_sales_list <- file_info %>%
  mutate(
    data = map(path, safe_read_report)
  )

all_sales <- all_sales_list %>%
  mutate(month = gsub("\\.csv", "", file_name)) %>%
  unnest(data) %>%
  select(-path, -file_name) 

cat("\n–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –æ–±'—î–¥–Ω–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–µ—Ä—à—ñ —Ä—è–¥–∫–∏ all_sales:\n")
print(head(all_sales))

```

### **–ï—Ç–∞–ø 2: –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö**

-   –î–æ–¥–∞–π—Ç–µ —Å—Ç–æ–≤–ø–µ—Ü—å `month` –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `"jan"` ‚Üí `"2024-01"`).
-   –†–æ–∑—Ä–∞—Ö—É–π—Ç–µ `revenue = units_sold * price_per_unit * (1 - discount_percent / 100)`.
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **–≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó**, –∞ –Ω–µ —Ü–∏–∫–ª–∏.
-   –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è –æ–±—á–∏—Å–ª—ñ—Ç—å:
    -   –∑–∞–≥–∞–ª—å–Ω–∏–π –¥–æ—Ö—ñ–¥ (`total_revenue`),
    -   —Å–µ—Ä–µ–¥–Ω—é —Ü—ñ–Ω—É (`avg_price`),
    -   –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ (`n_products`).

> üí° –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `group_by()` + `summarise()` ‚Äî –Ω–µ `for`!

```{r}
aggregated_sales <- all_sales %>%
  mutate(
    month_num = match(month, months),
    month_formatted = paste0("2024-", sprintf("%02d", month_num)),
    .before = month
  ) %>%
  select(-month, -month_num) %>%
  rename(month = month_formatted) %>%
  # –≤–∏–¥–∞–ª–µ–Ω–Ω—è –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å
  filter(price_per_unit >= 0, units_sold >= 0) %>%
  # —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –¥–æ—Ö–æ–¥—É
  mutate(
    revenue = units_sold * price_per_unit * (1 - discount_percent / 100)
  ) %>%
  # –∞–≥—Ä–µ–≥–∞—Ü—ñ—è –∑–∞ –º—ñ—Å—è—Ü–µ–º
  group_by(month) %>%
  summarise(
    total_revenue = sum(revenue, na.rm = TRUE),
    avg_price_weighted = sum(price_per_unit * units_sold, na.rm = TRUE) / sum(units_sold, na.rm = TRUE),
    n_products = n_distinct(product_id, na.rm = TRUE),
    .groups = "drop"
  )

cat("\n–ê–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:\n")
print(aggregated_sales)
```

### **–ï—Ç–∞–ø 3: –ê–Ω–∞–ª—ñ–∑ —è–∫–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö**

-   –í–∏–∑–Ω–∞—á—Ç–µ, **—Å–∫—ñ–ª—å–∫–∏ —Ñ–∞–π–ª—ñ–≤ –±—É–ª–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–æ** (–ø–æ—Ä—ñ–≤–Ω—è–π—Ç–µ –æ—á—ñ–∫—É–≤–∞–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤ —ñ–∑ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–º–∏).
-   –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –º—ñ—Å—è—Ü—è –æ–±—á–∏—Å–ª—ñ—Ç—å **—á–∞—Å—Ç–∫—É —Ä—è–¥–∫—ñ–≤ –∑ `NA`** —É –±—É–¥—å-—è–∫–æ–º—É —Å—Ç–æ–≤–ø—Ü—ñ.
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `colSums(is.na(...))` ‚Äî –Ω–µ —Ü–∏–∫–ª–∏!

```{r}
# –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ—á—ñ–∫—É–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
expected_files <- length(months)

# –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ (–¥–µ DataFrame –Ω–µ —î –ø–æ—Ä–æ–∂–Ω—ñ–º)
loaded_files_count <- all_sales_list %>%
  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —è–∫—ñ Data Frames –Ω–µ —î –ø–æ—Ä–æ–∂–Ω—ñ–º–∏
  mutate(is_empty = map_lgl(data, ~ nrow(.x) == 0)) %>%
  summarise(
    success_count = sum(!is_empty),
    failure_count = sum(is_empty)
  )

cat(sprintf("\n--- –ê–Ω–∞–ª—ñ–∑ —è–∫–æ—Å—Ç—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ---\n"))
cat(sprintf("–û—á—ñ–∫—É–≤–∞–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤: %d\n", expected_files))
cat(sprintf("–ö—ñ–ª—å–∫—ñ—Å—Ç—å —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤: %d\n", loaded_files_count$success_count))
cat(sprintf("–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏—Ö/–ø–æ—Ä–æ–∂–Ω—ñ—Ö —Ñ–∞–π–ª—ñ–≤: %d\n", loaded_files_count$failure_count))

na_analysis <- all_sales %>%
  group_by(month) %>%
  # –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å NA –≤ –∫–æ–∂–Ω–æ–º—É —Å—Ç–æ–≤–ø—Ü—ñ –¥–ª—è –∫–æ–∂–Ω–æ—ó –≥—Ä—É–ø–∏
  summarise(
    total_rows = n(),
    # –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É NA –ø–æ –≤—Å—ñ—Ö —Å—Ç–æ–≤–ø—Ü—è—Ö
    n_na_rows = sum(rowSums(is.na(select(cur_data(), everything()))) > 0),
    .groups = "drop"
  ) %>%
  mutate(
    # –ß–∞—Å—Ç–∫–∞ —Ä—è–¥–∫—ñ–≤, —â–æ –º—ñ—Å—Ç—è—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω–µ NA
    na_row_proportion = n_na_rows / total_rows
  )

cat("\n–ß–∞—Å—Ç–∫–∞ —Ä—è–¥–∫—ñ–≤ –∑ NA (–∑–∞ –º—ñ—Å—è—Ü–µ–º):\n")
print(na_analysis)
```

#### **–ï—Ç–∞–ø 4: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—ñ–¥—Ö–æ–¥—ñ–≤ (–Ω–∞ –ø—Ä–∏–∫–ª–∞–¥—ñ)**

-   –ù–∞–ø–∏—à—ñ—Ç—å **–æ–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫** –¥–≤–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏:
    1.  –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `for`-—Ü–∏–∫–ª—É (–¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó).
    2.  –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `vapply()` –∞–±–æ `sapply()`.
-   –ü–æ—Ä—ñ–≤–Ω—è–π—Ç–µ —à–≤–∏–¥–∫—ñ—Å—Ç—å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `system.time()` (–Ω–µ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ –≤ –∑–≤—ñ—Ç—ñ, –∞–ª–µ –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è).

```{r}
# –°–µ—Ä–µ–¥–Ω—è units_sold –∑–∞ –º—ñ—Å—è—Ü—å
data_for_comparison <- all_sales %>% 
  mutate(month_id = match(month, months)) %>%
  select(month_id, units_sold)

months_unique <- unique(data_for_comparison$month_id)

# --------------------
# 1. –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é for-—Ü–∏–∫–ª—É
# --------------------
time_for_loop <- system.time({
  results_for <- list()
  for (m_id in months_unique) {
    avg_u <- mean(data_for_comparison$units_sold[data_for_comparison$month_id == m_id], na.rm = TRUE)
    results_for[[as.character(m_id)]] <- avg_u
  }
})

# --------------------
# 2. –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é sapply (–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥)
# --------------------
time_sapply <- system.time({
  results_sapply <- sapply(months_unique, function(m_id) {
    mean(data_for_comparison$units_sold[data_for_comparison$month_id == m_id], na.rm = TRUE)
  })
})

cat("\n--- –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ –æ–±—á–∏—Å–ª–µ–Ω—å ---\n")
cat("–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ (–ø–µ—Ä—à—ñ 5): \n")
cat("For-—Ü–∏–∫–ª: ", paste(round(head(unlist(results_for)), 2), collapse = ", "), "\n")
cat("sapply:   ", paste(round(head(results_sapply), 2), collapse = ", "), "\n")
cat("\n–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:\n")
print(tibble(
  Method = c("for-—Ü–∏–∫–ª", "sapply"),
  Time = c(time_for_loop["elapsed"], time_sapply["elapsed"])
))

```

–ù–∞ –≤–µ–ª–∏–∫–∏—Ö –¥–∞–Ω–∏—Ö, —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ/–≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏ (sapply, map, dplyr) –∑–∞–∑–≤–∏—á–∞–π –∑–Ω–∞—á–Ω–æ —à–≤–∏–¥—à—ñ –∑–∞ —è–≤–Ω—ñ for-—Ü–∏–∫–ª–∏.

### –¢–µ—Ö–Ω—ñ—á–Ω—ñ –≤–∏–º–æ–≥–∏

-   –£–≤–µ—Å—å –∫–æ–¥ –º–∞—î –±—É—Ç–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–π —É **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—ñ**.
-   **–ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `for`, `while`, `repeat`** —É –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ä—ñ—à–µ–Ω–Ω—ñ (–ª–∏—à–µ –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –≤ –ï—Ç–∞–ø—ñ 4).
-   –£—Å—ñ —Ñ–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ –ø–∞–ø–∫–∏ `data/monthly_reports/`.
-   –ö–æ–Ω–≤–µ—î—Ä –º–∞—î –±—É—Ç–∏ **–≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–∏–º** —ñ **—Å—Ç—ñ–π–∫–∏–º –¥–æ –ø–æ–º–∏–ª–æ–∫**.

```{=html}
<hr style="border: 1px solid #ddd; margin: 30px 0 10px 0;">
<footer style="text-align: center; font-size: 0.9em; color: #666; padding: 15px; background: #f9f9f9; border-top: 1px solid #eee; margin-top: 20px;">
  <p><strong>–í–∏–∫–æ–Ω–∞–≤(–ª–∞): –í–∞—à–µ –ü–Ü–ë</strong> | –ì—Ä—É–ø–∞: <strong>–í–∞—à–∞ –≥—Ä—É–ø–∞</strong> | –í–∏–∫–ª–∞–¥–∞—á: –°–∏–¥–æ—Ä–µ–Ω–∫–æ –í.–ú.</p>
  <p>–ö—Ä–µ–º–µ–Ω—á—É—Ü—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –ú–∏—Ö–∞–π–ª–∞ –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ &copy; 2025</p>
</footer>
```
