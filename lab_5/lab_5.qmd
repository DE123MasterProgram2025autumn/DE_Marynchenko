---
title: "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞ ‚Ññ5: –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –≤ R"
subtitle: "–Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –¥–∞–Ω–∏—Ö | –ö—Ä–ù–£ —ñ–º. –ú. –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ"
author: "[–°–∏–¥–æ—Ä–µ–Ω–∫–æ –í–∞–ª–µ—Ä—ñ–π](https://www.linkedin.com/in/valeriy-sydorenko-6782279a/)"
date: last-modified
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    sidebar: left
    collapse-level: 2
    code-fold: true
    code-overflow: wrap
    page-layout: full
#     include-in-footer:
#       text: |
#         <hr>
#         <footer style="text-align: center; font-size: 0.9em; color: #666;">
#           <p>–í–∏–∫–æ–Ω–∞–≤(–ª–∞): <strong>–í–∞—à–µ –ü–Ü–ë</strong> | –ì—Ä—É–ø–∞: <strong>–í–∞—à–∞ –≥—Ä—É–ø–∞</strong> | –í–∏–∫–ª–∞–¥–∞—á: –°–∏–¥–æ—Ä–µ–Ω–∫–æ –í.–ú.</p>
#           <p>–ö—Ä–µ–º–µ–Ω—á—É—Ü—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –ú–∏—Ö–∞–π–ª–∞ –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ &copy; 2025</p>
#         </footer>
# editor: visual
editor: visual
execute:
  echo: true
  warning: false
  message: false
---

## –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏

–û—Å–≤–æ—ó—Ç–∏ —Å—É—á–∞—Å–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏ –¥–æ *—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è* –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞–∫–µ—Ç–∞ `purrr` —Ç–∞ –Ω–∞–≤—á–∏—Ç–∏—Å—è *–º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è* —á–µ—Ä–µ–∑ *–±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å* (`foreach`, `furrr`, `future`). –ù–∞–≤—á–∏—Ç–∏—Å—è –±—É–¥—É–≤–∞—Ç–∏ *–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ, —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ —Ç–∞ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ –∫–æ–Ω–≤–µ—î—Ä–∏ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö*, —è–∫—ñ –º–æ–∂—É—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –≤–µ–ª–∏–∫–∏–º–∏ –æ–±—Å—è–≥–∞–º–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∞–±–æ –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∏–º–∏ –æ–ø–µ—Ä–∞—Ü—ñ—è–º–∏.

------------------------------------------------------------------------

## –©–æ –≤–∏ –±—É–¥–µ—Ç–µ –≤–º—ñ—Ç–∏ –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–æ–±–æ—Ç–∏?

-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **—Ñ—É–Ω–∫—Ü—ñ—ó —Å—ñ–º–µ–π—Å—Ç–≤–∞ `map`** (`map_dfr`, `map2`, `pmap`) –¥–ª—è –µ–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤, –¥–∞—Ç–∞—Ñ—Ä–µ–π–º—ñ–≤ —Ç–∞ —Ñ–∞–π–ª—ñ–≤.\
-   –ó–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ **—Ñ—É–Ω–∫—Ü—ñ—ó `walk`** –¥–ª—è –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–ø–∏—Å —Ñ–∞–π–ª—ñ–≤) –±–µ–∑ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ–º—ñ–∂–Ω–∏—Ö –æ–±‚Äô—î–∫—Ç—ñ–≤.\
-   –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **`keep()` —Ç–∞ `discard()`** –Ω–∞ –æ—Å–Ω–æ–≤—ñ —É–º–æ–≤.\
-   –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ **–ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **`reduce()` —Ç–∞ `accumulate()`** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ª–∞–Ω—Ü—é–∂–∫–∏ `left_join`).\
-   –†–µ–∞–ª—ñ–∑–æ–≤—É–≤–∞—Ç–∏ **–±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è** —á–µ—Ä–µ–∑ `foreach`, `furrr` —Ç–∞ `future`.\
-   –ö–µ—Ä—É–≤–∞—Ç–∏ **—Ä–µ—Å—É—Ä—Å–∞–º–∏ –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `plan(multisession)` —Ç–∞ `availableCores()`.\
-   –ë—É–¥—É–≤–∞—Ç–∏ **–≤–∫–ª–∞–¥–µ–Ω—ñ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –ø—Ä–æ—Ü–µ—Å–∏** —Ç–∞ –æ–±—Ä–æ–±–ª—è—Ç–∏ –ø–æ–º–∏–ª–∫–∏ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ.

------------------------------------------------------------------------

## –í—Å—Ç—É–ø

–£ —Å–≤—ñ—Ç—ñ —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å ‚Äî —Ü–µ –Ω–µ —Ä–æ–∑–∫—ñ—à, –∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å. –ù–∞–≤—ñ—Ç—å –Ω–∞–π–µ–ª–µ–≥–∞–Ω—Ç–Ω—ñ—à–∏–π –∫–æ–¥ —Å—Ç–∞—î –º–∞—Ä–Ω–∏–º, —è–∫—â–æ –≤—ñ–Ω –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≥–æ–¥–∏–Ω–∞–º–∏. –¢–æ–º—É —Å—É—á–∞—Å–Ω–∏–π —ñ–Ω–∂–µ–Ω–µ—Ä –¥–∞–Ω–∏—Ö –ø–æ–≤–∏–Ω–µ–Ω –≤–æ–ª–æ–¥—ñ—Ç–∏ **–¥–≤–æ–º–∞ –∫–ª—é—á–æ–≤–∏–º–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü—ñ—è–º–∏**:

1.  **–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è** ‚Äî –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è **—á–∏—Å—Ç–æ–≥–æ, –º–æ–¥—É–ª—å–Ω–æ–≥–æ —Ç–∞ –ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–æ–≥–æ –∫–æ–¥—É**.
2.  **–ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è** ‚Äî –¥–ª—è **–º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** —Ü—å–æ–≥–æ –∫–æ–¥—É –Ω–∞ –±–∞–≥–∞—Ç–æ—è–¥–µ—Ä–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö.

–¶—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑–Ω–∞–π–æ–º–∏—Ç—å –≤–∞—Å —ñ–∑:

-   **–ü–∞–∫–µ—Ç–æ–º `purrr`** ‚Äî —è–∫–∏–π —É–Ω—ñ—Ñ—ñ–∫—É—î –ø—ñ–¥—Ö—ñ–¥ –¥–æ —ñ—Ç–µ—Ä–∞—Ü—ñ–π, –∑–∞–º—ñ–Ω—é—é—á–∏ —Ü–∏–∫–ª–∏ –Ω–∞ –≤–∏—Ä–∞–∑–Ω—ñ, —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª–∏ (`map_dfr`, `pmap`, `walk` —Ç–æ—â–æ).
-   **–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º—É**:
    -   `foreach` ‚Äî –¥–ª—è –±–∞–∑–æ–≤–æ—ó –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—ñ,\
    -   `furrr` ‚Äî –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó `purrr` –∑ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–º–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è–º–∏,\
    -   `future` ‚Äî –¥–ª—è –ø—Ä–æ—Å—É–Ω—É—Ç–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å–∞–º–∏, –≤–∫–ª—é—á–Ω–æ –∑ –≤–∫–ª–∞–¥–µ–Ω–∏–º–∏ —Ñ'—é—á–µ—Ä—Å–∞–º–∏ —Ç–∞ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫.

–ú–∏ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ–º–æ –∑ **—Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–º —Å—Ü–µ–Ω–∞—Ä—ñ—î–º**: –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è, —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è, –∞–Ω–∞–ª—ñ–∑ —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö. –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å –Ω–∞–º –ø–æ–±–∞—á–∏—Ç–∏, —è–∫ **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —Å—Ç–∏–ª—å** –ø–æ—î–¥–Ω—É—î—Ç—å—Å—è –∑ **–ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–º–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è–º–∏** –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è production-ready –∫–æ–Ω–≤–µ—î—Ä—ñ–≤.

## –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –∑ –ø–∞–∫–µ—Ç–æ–º `purrr`

–ü–∞–∫–µ—Ç `purrr` —î —á–∞—Å—Ç–∏–Ω–æ—é –µ–∫–æ—Å–∏—Å—Ç–µ–º–∏ `tidyverse` —ñ –Ω–∞–¥–∞—î —Å—É—á–∞—Å–Ω–∏–π, —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –≤ R. –í—ñ–Ω –¥–æ–±—Ä–µ —ñ–Ω—Ç–µ–≥—Ä—É—î—Ç—å—Å—è –∑ –∫–æ–Ω–≤–µ—î—Ä–∞–º–∏ (`%>%`) —ñ –¥–æ–∑–≤–æ–ª—è—î –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–µ—Ç–∏–ø—ñ–∑–æ–≤–∞–Ω—ñ –±–∞–∑–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `lapply()`) –Ω–∞ –±–µ–∑–ø–µ—á–Ω—ñ—à—ñ —Ç–∞ –≤–∏—Ä–∞–∑–Ω—ñ—à—ñ –∞–Ω–∞–ª–æ–≥–∏.

#### **–û—Å–Ω–æ–≤–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏ `purrr`**:

-   **–¢–∏–ø—ñ–∑–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó**: –∫–æ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —á—ñ—Ç–∫–æ –≤–∏–∑–Ω–∞—á–∞—î —Ç–∏–ø –≤–∏—Ö—ñ–¥–Ω–∏—Ö –¥–∞–Ω–∏—Ö (–≤–µ–∫—Ç–æ—Ä, —Å–ø–∏—Å–æ–∫, data.frame), —â–æ —É—Å—É–≤–∞—î –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω—ñ –ø–æ–º–∏–ª–∫–∏.

-   **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ñ–æ—Ä–º—É–ª**: –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —á–µ—Ä–µ–∑ `~` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `~ .x + .y` –∑–∞–º—ñ—Å—Ç—å `function(x, y) x + y`).

-   **–ì–Ω—É—á–∫—ñ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤**: –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü—ñ–π –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –≤ —Ç—ñ–ª–æ –≤–∏–∫–ª–∏–∫—É.

-   **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫**: –ª–µ–≥–∫–æ –ø–æ—î–¥–Ω—É—î—Ç—å—Å—è –∑ `tryCatch()` —É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—ñ.

#### **–°—ñ–º–µ–π—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü—ñ–π `map_*`**:

-   `map()` ‚Äî –∞–Ω–∞–ª–æ–≥ `lapply()`, –∑–∞–≤–∂–¥–∏ –ø–æ–≤–µ—Ä—Ç–∞—î **—Å–ø–∏—Å–æ–∫**.

-   `map_lgl()`, `map_chr()`, `map_int()`, `map_dbl()` ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å **–≤–µ–∫—Ç–æ—Ä–∏** –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ —Ç–∏–ø—É.

-   `map_dfr()` ‚Äî –æ–±‚Äô—î–¥–Ω—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ —É **–æ–¥–∏–Ω data.frame –∑–∞ —Ä—è–¥–∫–∞–º–∏** (–∫–æ—Ä–∏—Å–Ω–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π).

-   `map_dfc()` ‚Äî –æ–±‚Äô—î–¥–Ω—É—î –∑–∞ **—Å—Ç–æ–≤–ø—Ü—è–º–∏**.

#### **–§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –∫—ñ–ª—å–∫–æ–º–∞ –æ–±‚Äô—î–∫—Ç–∞–º–∏**:

-   `map2()` ‚Äî —ñ—Ç–µ—Ä—É—î –ø–æ **–¥–≤–æ–º** –æ–±‚Äô—î–∫—Ç–∞–º –æ–¥–Ω–æ—á–∞—Å–Ω–æ.

-   `pmap()` ‚Äî —ñ—Ç–µ—Ä—É—î –ø–æ **–¥–æ–≤—ñ–ª—å–Ω—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ** –æ–±‚Äô—î–∫—Ç—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–æ —Ä—è–¥–∫–∞—Ö —Ç–∞–±–ª–∏—Ü—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤).

#### **–§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –ø–æ–±—ñ—á–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤**:

-   `walk()`, `walk2()`, `pwalk()` ‚Äî –≤–∏–∫–æ–Ω—É—é—Ç—å –¥—ñ—ó –±–µ–∑ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–∞–ø–∏—Å —Ñ–∞–π–ª—ñ–≤, –≤–∏–≤–µ–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤).

#### **–§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ –∫–æ–º–ø–æ–∑–∏—Ü—ñ—è**:

-   `keep()` / `discard()` ‚Äî —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å –µ–ª–µ–º–µ–Ω—Ç–∏ —Å–ø–∏—Å–∫—É –∑–∞ —É–º–æ–≤–æ—é.

-   `reduce()` / `accumulate()` ‚Äî –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å –±—ñ–Ω–∞—Ä–Ω—É –æ–ø–µ—Ä–∞—Ü—ñ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ª–∞–Ω—Ü—é–∂–æ–∫ `left_join`).

-   `invoke_map()` ‚Äî –∑–∞—Å—Ç–æ—Å–æ–≤—É—î **—Ä—ñ–∑–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó** –¥–æ –æ–¥–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤.

–¶—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –ø–∏—Å–∞—Ç–∏ **—á–∏—Å—Ç–∏–π, –º–æ–¥—É–ª—å–Ω–∏–π —ñ –ª–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏–π –∫–æ–¥**, —è–∫–∏–π —ñ–¥–µ–∞–ª—å–Ω–æ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ ETL-–∫–æ–Ω–≤–µ—î—Ä—ñ–≤ —É —Ä–∞–º–∫–∞—Ö —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö.

### –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è 1

–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ [—á–∞—Å—Ç–∏–Ω—É 1.](lab5_DE_2022_part1.R)

## –ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –∑ `foreach`

–ö–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è `foreach` –Ω–∞–¥–∞—î —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å —É –º–æ–≤—ñ R. –ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ü–∏–∫–ª—É `for`, `foreach` –¥–æ–∑–≤–æ–ª—è—î –ª–µ–≥–∫–æ –ø–µ—Ä–µ–º–∏–∫–∞—Ç–∏—Å—è –º—ñ–∂ **–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–º** (`%do%`) —Ç–∞ **–ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏–º** (`%dopar%`) —Ä–µ–∂–∏–º–∞–º–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ä—ñ–∑–Ω—ñ –±–µ–∫–µ–Ω–¥–∏, —Ç–∞–∫—ñ —è–∫ `doFuture` –∞–±–æ `doSNOW`.

–¶–µ–π –ø—ñ–¥—Ö—ñ–¥ –æ—Å–æ–±–ª–∏–≤–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π –¥–ª—è **–¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:

-   —ñ–º—ñ—Ç–∞—Ü—ñ—è –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤,

-   –æ–±—Ä–æ–±–∫–∞ –≤–µ–ª–∏–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤,

-   –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è –º–µ—Ç–æ–¥–æ–º –ú–æ–Ω—Ç–µ-–ö–∞—Ä–ª–æ.

–ö–ª—é—á–æ–≤—ñ –ø–µ—Ä–µ–≤–∞–≥–∏ `foreach`:

-   **–ü—Ä–æ—Å—Ç–∏–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å**, —Å—Ö–æ–∂–∏–π –Ω–∞ –∑–≤–∏—á–∞–π–Ω–∏–π —Ü–∏–∫–ª.

-   **–ì–Ω—É—á–∫–µ –æ–±‚Äô—î–¥–Ω–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤** —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `.combine` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `dplyr::bind_rows`).

-   **–õ–µ–≥–∫–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è** –∑ —ñ—Å–Ω—É—é—á–∏–º –∫–æ–¥–æ–º –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –ø–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏.

–•–æ—á–∞ `foreach` –Ω–µ —î —á–∞—Å—Ç–∏–Ω–æ—é –µ–∫–æ—Å–∏—Å—Ç–µ–º–∏ `tidyverse`, –≤—ñ–Ω –¥–æ–±—Ä–µ –ø–æ—î–¥–Ω—É—î—Ç—å—Å—è –∑ `dplyr` —Ç–∞ `purrr`, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫ –¥–æ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –æ–±—á–∏—Å–ª–µ–Ω—å —É —Ä–∞–º–∫–∞—Ö —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö.

### –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è 2

–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ [—á–∞—Å—Ç–∏–Ω—É 2.](lab5_DE_2022_part2.R)

## –ë–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ `pbapply`, `parallel` —Ç–∞ `furrr`

–î–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –ø–∞—Ä–∞–ª–µ–ª—ñ–∑–º—É –∑ —Å—É—á–∞—Å–Ω–∏–º–∏ –ø—ñ–¥—Ö–æ–¥–∞–º–∏ –¥–æ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–∞–∫–µ—Ç–∏:

-   **`pbapply`** –¥–æ–¥–∞—î **–≤–±—É–¥–æ–≤–∞–Ω–∏–π –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä** –¥–æ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –≤–µ—Ä—Å—ñ–π `lapply()` (`pblapply()`), —â–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Ç—Ä–∏–≤–∞–ª–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤.

-   **`parallel`** –Ω–∞–¥–∞—î **–Ω–∏–∑—å–∫–æ—Ä—ñ–≤–Ω–µ–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å** —á–µ—Ä–µ–∑ `makeCluster()` —Ç–∞ `parLapply()`, —â–æ –∫–æ—Ä–∏—Å–Ω–æ –¥–ª—è —Ç–æ–Ω–∫–æ—ó –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—É—Ä—Å—ñ–≤ —É production-—Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö.

-   **`furrr`** ‚Äî —Ü–µ **–±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–∞–∫–µ—Ç–∞ `purrr`**, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î –∑–∞–º—ñ–Ω–∏—Ç–∏ `map2()` –Ω–∞ `future_map2()` –æ–¥–Ω–∏–º —Ä—è–¥–∫–æ–º, –∑–±–µ—Ä—ñ–≥–∞—é—á–∏ –≤—Å—é –≤–∏—Ä–∞–∑–Ω—ñ—Å—Ç—å —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—é.

–¶—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å **–º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –∫–æ–Ω–≤–µ—î—Ä–∏** –±–µ–∑ –∑–º—ñ–Ω–∏ —ó—Ö–Ω—å–æ—ó –ª–æ–≥—ñ–∫–∏, —â–æ —Ä–æ–±–∏—Ç—å —ó—Ö —ñ–¥–µ–∞–ª—å–Ω–∏–º–∏ –¥–ª—è —ñ–Ω–∂–µ–Ω–µ—Ä—ñ—ó –¥–∞–Ω–∏—Ö, –¥–µ –≤–∞–∂–ª–∏–≤–æ –ø–æ—î–¥–Ω—É–≤–∞—Ç–∏ **—á–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å –∫–æ–¥—É –∑ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—é**.

### –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è 3

–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ [—á–∞—Å—Ç–∏–Ω—É 3.](lab5_DE_2022_part3.R)

## –ü—Ä–æ—Å—É–Ω—É—Ç–∞ –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å –∑ –ø–∞–∫–µ—Ç–æ–º `future`

–ü–∞–∫–µ—Ç `future` –ø—Ä–æ–ø–æ–Ω—É—î **—É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π, –º–æ–¥—É–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –¥–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å**. –í—ñ–Ω –¥–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ **—Ñ'—é—á–µ—Ä—Å–∏** ‚Äî –æ–±‚Äô—î–∫—Ç–∏, —è–∫—ñ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —â–æ –±—É–¥–µ –æ–±—á–∏—Å–ª–µ–Ω–∏–π —É –º–∞–π–±—É—Ç–Ω—å–æ–º—É. –ö–ª—é—á–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:

-   **–Ø–≤–Ω–µ** (`future({...})`) —Ç–∞ **–Ω–µ—è–≤–Ω–µ** (`x %<-% {...}`) –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è —Ñ'—é—á–µ—Ä—Å—ñ–≤.
-   **–ì–Ω—É—á–∫–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–ª–∞–Ω–æ–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**: `sequential`, `multisession`, `cluster`.
-   **–í–∫–ª–∞–¥–µ–Ω—ñ —Ñ'—é—á–µ—Ä—Å–∏** –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—ñ–≤, –∫–æ–∂–µ–Ω –∑ —è–∫–∏—Ö –º—ñ—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –ø—ñ–¥–ø—Ä–æ—Ü–µ—Å–∏).
-   **–ë–µ–∑–ø–µ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫** —á–µ—Ä–µ–∑ `resolved()` —Ç–∞ `backtrace()`.
-   **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ `promises`** –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–∏—Ö –∫–æ–Ω–≤–µ—î—Ä—ñ–≤ –∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–æ–º.

–¶–µ –Ω–∞–π–ø–æ—Ç—É–∂–Ω—ñ—à–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É –∞—Ä—Å–µ–Ω–∞–ª—ñ —ñ–Ω–∂–µ–Ω–µ—Ä–∞ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ **–º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏—Ö, –Ω–∞–¥—ñ–π–Ω–∏—Ö —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏—Ö ETL-–ø—Ä–æ—Ü–µ—Å—ñ–≤**, —è–∫—ñ –º–æ–∂—É—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ñ–π –±–∞–≥–∞—Ç–æ—è–¥–µ—Ä–Ω—ñ–π –º–∞—à–∏–Ω—ñ, —É —Ö–º–∞—Ä—ñ –∞–±–æ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä—ñ.

### –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è 4

–û–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ [—á–∞—Å—Ç–∏–Ω—É 4.](lab5_DE_2022_part4.R)

## –†–æ–±–æ—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è

## –í–∞—Ä—ñ–∞–Ω—Ç 1

### –¢–µ–º–∞: –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö

–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ **7 —Ñ–∞–π–ª—ñ–≤** (`transaction_1.csv` ‚Äì `transaction_7.csv`), –∫–æ–∂–µ–Ω –∑ —è–∫–∏—Ö –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é (—è–∫ —É –ø—Ä–∏–∫–ª–∞–¥—ñ). –û–¥–Ω–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó —Ç–∞–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ **—Ç–∏—Å—è—á—ñ**, —ñ –æ–±—Ä–æ–±–∫–∞ —ó—Ö –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –∑–∞–π–º–µ –Ω–µ–ø—Ä–∏–π–Ω—è—Ç–Ω–æ –±–∞–≥–∞—Ç–æ —á–∞—Å—É.

–í–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø–æ–±—É–¥—É–≤–∞—Ç–∏ **–º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π, –Ω–∞–¥—ñ–π–Ω–∏–π —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π ETL-–∫–æ–Ω–≤–µ—î—Ä**, —è–∫–∏–π:

1.  –ë–µ–∑–ø–µ—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤—Å—ñ —Ñ–∞–π–ª–∏ (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–µ—è–∫—ñ –ø–æ—à–∫–æ–¥–∂–µ–Ω—ñ)
2.  –ê–≥—Ä–µ–≥—É—î –¥–∞–Ω—ñ
3.  –í–∏–∫–æ–Ω—É—î –∞–Ω–∞–ª—ñ–∑
4.  –ó–±–µ—Ä—ñ–≥–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî **–≤—Å–µ —Ü–µ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å**.

------------------------------------------------------------------------

### üìå –ó–∞–≤–¥–∞–Ω–Ω—è

#### **–ï—Ç–∞–ø 1: –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è (purrr)**

-   –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `safe_read_transaction(path)`, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `tryCatch()` –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ —á–∏—Ç–∞–Ω–Ω—è CSV.
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `list.files()` + `map()` –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤.
-   –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑ **–∑–∞–≥–∞–ª—å–Ω–æ—é —Å—É–º–æ—é (`sale_sum`) ‚â• 1000** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `keep()`.

```{r}
library(readr)
library(dplyr)
library(purrr)
safe_read_transaction <- function(path) {
  tryCatch(
    {
      data <- readr::read_csv(path, show_col_types = FALSE)
      # data validation
      if (!"sale_sum" %in% names(data) || !is.numeric(data$sale_sum) || nrow(data) == 0) {
        stop("'sale_sum' is empty")
      }
      return(data)
    },
    error = function(e) {
      warning(paste("error in:", path, "\n  reason:", e$message))
      # return NULL for fale
      return(NULL)
    }
  )
}

# get data path
file_paths <- list.files(
  path = "data/transactions.", 
  pattern = "\\.csv$", 
  full.names = TRUE
)

cat(paste("Found", length(file_paths), "files...\n"))

all_results <- map(file_paths, safe_read_transaction)

# compact() deletes NULL results
successful_transactions <- compact(all_results)

cat(paste("sucsessfuly loaded and validated:", length(successful_transactions), "files.\n"))
cat(paste("couldn't validate:", length(all_results) - length(successful_transactions), "files.\n\n"))


high_value_transactions <- keep(successful_transactions, ~ .x$sale_sum[1] >= 1000)

cat(paste("number of transaction with sale_sum >= 1000:", length(high_value_transactions), "\n"))

# saving results
final_filtered_data <- bind_rows(high_value_transactions)

print(final_filtered_data)
```

#### **–ï—Ç–∞–ø 2: –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü—ñ—è (reduce)**

-   –û–±‚Äô—î–¥–Ω–∞–π—Ç–µ –≤—Å—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ —î–¥–∏–Ω—É —Ç–∞–±–ª–∏—Ü—é –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `reduce(bind_rows)`.
-   –î–æ–¥–∞–π—Ç–µ —Å—Ç–æ–≤–ø–µ—Ü—å `file_id` –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É.

```{r}
all_transactions_combined <- bind_rows(successful_transactions, .id = "file_path")

all_transactions_with_id <- all_transactions_combined %>% 
  mutate(
    # create file_id from full path
    file_id = fs::path_file(file_path),      # "transaction_1.csv"
    file_id = fs::path_ext_remove(file_id) # "transaction_1"
  ) %>% 
  # select columns
  select(file_id, file_path, everything())

cat("joined table\n")
print(all_transactions_with_id)

# filterring
cat("\nfiltered table (>= 1000) after joining\n")
final_high_value_table <- all_transactions_with_id %>% 
  filter(sale_sum >= 1000)

print(final_high_value_table)
```

#### **–ï—Ç–∞–ø 3: –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ (foreach + furrr)**

-   –ù–∞–ø–∏—à—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `analyze_manager(df)`, —è–∫–∞ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ä–∞—Ö—É—î:
    -   –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π,
    -   –∑–∞–≥–∞–ª—å–Ω—É —Å—É–º—É –ø—Ä–æ–¥–∞–∂—ñ–≤,
    -   —Å–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫.
-   –í–∏–∫–æ–Ω–∞–π—Ç–µ —Ü–µ–π –∞–Ω–∞–ª—ñ–∑ **–¥–≤–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏**:
    1.  –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `foreach(..., .combine = bind_rows) %dopar%`.
    2.  –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `future_map_dfr()` –∑ `furrr`.

```{r}
library(doFuture)
analyze_manager <- function(df) {
  # df - transactions for one manager
  summarize(
    df,
    transaction_count = n(),
    total_sales = sum(sale_sum),
    avg_sale = mean(sale_sum),
    .groups = 'drop' # for summarize
  )
}

nested_data <- all_transactions_combined %>%
  group_by(manager) %>%
  group_nest()

cat("\n data ready to paralelism (nested_data):\n")
print(nested_data)

plan(multisession, workers = 4)
cat(paste("\nParalel backend starts with ", nbrOfWorkers(), "emploees\n"))

registerDoFuture()

cat("\nanalise with foreach %dopar% ...\n")

# iterate managers by names
foreach_results <- foreach(
  mgr_name = nested_data$manager,
  mgr_data = nested_data$data,
  .combine = bind_rows
) %dopar% {
  
  # call analize function for manager
  stats <- analyze_manager(mgr_data)
  
  # add manager's name to result
  mutate(stats, manager = mgr_name, .before = 1)
}

cat("result (foreach): \n")
print(foreach_results)

cat("\nanalize whith future_map_dfr() ...\n")

input_list <- set_names(nested_data$data, nested_data$manager)

furrr_results <- future_map_dfr(
  input_list, 
  analyze_manager, 
  .id = "manager"
)

cat("result (furrr):\n")
print(furrr_results)


# stop from paralel backend
plan(sequential)
cat("\nparalel back-end was stoped\n")
```

#### **–ï—Ç–∞–ø 4: –ü—Ä–æ—Å—É–Ω—É—Ç–∞ –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å (future)**

-   –°—Ç–≤–æ—Ä—ñ—Ç—å **–≤–∫–ª–∞–¥–µ–Ω—ñ —Ñ'—é—á–µ—Ä—Å–∏**:
    -   –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Ñ'—é—á–µ—Ä—Å ‚Äî –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É.
    -   –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ñ'—é—á–µ—Ä—Å ‚Äî –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Ü—ñ–Ω–∏).
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `plan(list(multisession, multisession))`.
-   –î–æ–¥–∞–π—Ç–µ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ —á–µ—Ä–µ–∑ `resolved()` —Ç–∞ `backtrace()`.

```{r}
library(future)
library(furrr)
validate_row <- function(row_num, row_data) {
  tryCatch({
    
    # error no data
    if (is.na(row_data$quantity) || is.na(row_data$price) || is.na(row_data$price_check_sum)) {
      stop("No data. coudn't validate.")
    }
    
    # error business logic
    calculated_sum <- row_data$quantity * row_data$price
    if (calculated_sum != row_data$price_check_sum) {
      stop(paste0("unexpected control summ. expected: ", 
                  calculated_sum, ", got: ", row_data$price_check_sum))
    }
    
    return(list(
      status = "success", 
      row = row_num, 
      item = row_data$item_id
    ))
    
  }, error = function(e) {
    return(list(
      status = "error", 
      row = row_num, 
      item = row_data$item_id, 
      message = e$message
    ))
  })
}


# first futures (work with each file)
process_file <- function(path) {
  # first level
  data <- readr::read_csv(path, show_col_types = FALSE)
  
  required_cols <- c("item_id", "quantity", "price", "price_check_sum")
  if (!all(required_cols %in% names(data))) {
    stop("file doesn't have some columns (e.g. 'price_check_sum').")
  }
  
  # split dataframe to list of rows
  rows_list <- split(data, seq(nrow(data)))
  
  # internal fututes
  inner_futures <- imap(rows_list, ~ {
    row_num <- as.integer(.y)
    row_tibble <- .x
    future({
      validate_row(row_num, row_tibble)
    }, seed = TRUE) # seed = TRUE - just must to be here, good practise, IDK :(
  })
  
  # 4. join internal results
  inner_results <- values(inner_futures)
  
  return(list(file = path, results = inner_results))
}

# setting up plans.
plan(list(
  tweak(multisession, workers = 2), # plan for first futures (files)
  tweak(multisession, workers = 4)  # plan for internal futures (rows)
))

# nbrOfWorkers() give number of workers for first plan
outer_workers_count <- nbrOfWorkers()

cat(paste0(
  "set up 2nd plan\n",
  "files: ", outer_workers_count, " workers\n",
  "rows: 4 workers(like in the task)\n\n"
))

#start external futures

file_paths <- list.files(
  path = "transactions", 
  pattern = "^transaction_.*\\.csv$", 
  full.names = TRUE
)

cat("start of", length(file_paths), "external futures(one for each file)...\n")

outer_futures <- map(file_paths, ~ {
  # future() for first plan
  future({
    # work with file
    process_file(.)
  }, seed = TRUE, .globals = c("validate_row", "process_file")) 
})

cat("\nresults\n")
all_results <- list()
all_errors <- list()

for (i in seq_along(outer_futures)) {
  f <- outer_futures[[i]]
  path <- file_paths[[i]]
  
  cat(paste("\n–û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—É:", basename(path), "\n"))

  wait(f) 
  
  if (resolved(f)) {
    
    result_or_error <- tryCatch(
      {
        list(status = "success", data = value(f))
      },
      error = function(e) {
        list(status = "error", error = e, traceback = f$traceback)
      }
    )
    
    if (result_or_error$status == "success") {

      cat("  file level: sucsessfuly loaded and analise.\n")
      all_results[[path]] <- result_or_error$data$results
      walk(result_or_error$data$results, ~ {
        if (.x$status == "success") {
          cat(paste0("    row level (", .x$item, "): sucsessfuly validated.\n"))
        } else {
          cat(paste0("    row level (", .x$item, "): error: ", .x$message, "\n"))
        }
      })
      
    } else {
      cat(paste0("  file level: critical error: ", result_or_error$error$message, "\n"))
      all_errors[[path]] <- result_or_error
      cat("  Backtrace:\n")
      print(result_or_error$traceback) 
    }
    
  } else {
    cat(paste0("  file level: unknown error.\n"))
  }
}

cat(paste("succeccfuly (file level):", length(all_results), "\n"))
cat(paste("file catch critical error:", length(all_errors), "\n"))

final_row_results <- all_results %>% 
  map("results") %>%
  flatten() %>% 
  map_dfr(as_tibble)

cat("\ntable of all rows\n")
print(final_row_results)

plan(sequential)
cat("\nparalel backend was stoped\n")
```

#### **–ï—Ç–∞–ø 5: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤**

-   –ó–±–µ—Ä–µ–∂—ñ—Ç—å –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —É —Ñ–∞–π–ª–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `walk2()` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `high_value_1.csv`, `high_value_2.csv`, ...).

```{r}
output_dir <- "data/transactions/high_value_output"
dir.create(output_dir, showWarnings = FALSE)

# generate file names
n_files <- length(high_value_transactions)
sequence <- seq_len(n_files)

output_filenames <- paste0("high_value_", sequence, ".csv")
output_paths <- fs::path(output_dir, output_filenames)

cat(paste("files will be save in :\n", paste(output_paths, collapse = ", "), "\n"))


## saving with walk2()

walk2(
  .x = high_value_transactions, # Data frame (df)
  .y = output_paths,
  .f = ~ {
    # .x - current data frame
    # .y - current —à–ª—è—Ö
    readr::write_csv(.x, file = .y)
    cat(paste("  file was saved:", basename(.y), "\n"))
  }
)

cat("\nresults were saved\n")

## 5.3 –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
cat("\nfiles were saved in:\n")
list.files(output_dir)
```

------------------------------------------------------------------------

### üí° –¢–µ—Ö–Ω—ñ—á–Ω—ñ –≤–∏–º–æ–≥–∏

-   –£–≤–µ—Å—å –∫–æ–¥ –º–∞—î –±—É—Ç–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–π —É **—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–º—É —Å—Ç–∏–ª—ñ**.
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **–ª–∏—à–µ** `purrr`, `foreach`, `furrr`, `future` ‚Äî **–±–µ–∑ —Ü–∏–∫–ª—ñ–≤ `for`/`while`**.
-   –ö–æ–Ω–≤–µ—î—Ä –º–∞—î –±—É—Ç–∏ **–≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–∏–º**, **—Å—Ç—ñ–π–∫–∏–º –¥–æ –ø–æ–º–∏–ª–æ–∫** —Ç–∞ **–º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–º**.
-   –£—Å—ñ —Ñ–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ –ø–∞–ø–∫–∏ `data/transactions/`.

```{=html}
<hr style="border: 1px solid #ddd; margin: 30px 0 10px 0;">
<footer style="text-align: center; font-size: 0.9em; color: #666; padding: 15px; background: #f9f9f9; border-top: 1px solid #eee; margin-top: 20px;">
  <p><strong>–í–∏–∫–æ–Ω–∞–≤(–ª–∞): –í–∞—à–µ –ü–Ü–ë</strong> | –ì—Ä—É–ø–∞: <strong>–í–∞—à–∞ –≥—Ä—É–ø–∞</strong> | –í–∏–∫–ª–∞–¥–∞—á: –°–∏–¥–æ—Ä–µ–Ω–∫–æ –í.–ú.</p>
  <p>–ö—Ä–µ–º–µ–Ω—á—É—Ü—å–∫–∏–π –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç —ñ–º–µ–Ω—ñ –ú–∏—Ö–∞–π–ª–∞ –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ &copy; 2025</p>
</footer>
```
